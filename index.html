<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GlassBox ‚Äì Solana Token Risk Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script>
  const API_BASE = "/api/check";
  const RECENT_KEY = "glassbox_recent_mints_v1";

  const mintInput = document.getElementById("mintInput");
  const checkBtn = document.getElementById("checkBtn");
  const checkBtnLabel = document.getElementById("checkBtnLabel");
  const checkBtnSpinner = document.getElementById("checkBtnSpinner");
  const resultBox = document.getElementById("resultBox");
  const errorBox = document.getElementById("errorBox");
  const recentRow = document.getElementById("recentRow");

  function setLoading(isLoading) {
    if (isLoading) {
      checkBtn.disabled = true;
      checkBtnLabel.textContent = "Scanning‚Ä¶";
      checkBtnSpinner.style.display = "inline";
    } else {
      checkBtn.disabled = false;
      checkBtnLabel.textContent = "Scan";
      checkBtnSpinner.style.display = "none";
    }
  }

  // ---------- PRICE FORMATTING (with 0.0‚ÇÜ57 style) ----------

  const SUBSCRIPT_MAP = {
    "0": "‚ÇÄ",
    "1": "‚ÇÅ",
    "2": "‚ÇÇ",
    "3": "‚ÇÉ",
    "4": "‚ÇÑ",
    "5": "‚ÇÖ",
    "6": "‚ÇÜ",
    "7": "‚Çá",
    "8": "‚Çà",
    "9": "‚Çâ",
  };

  function toSubscript(num) {
    return String(num)
      .split("")
      .map((d) => SUBSCRIPT_MAP[d] || d)
      .join("");
  }

  // For super tiny prices like 0.00000057 ‚Üí "$0.0‚ÇÜ57"
  function formatTinyUsd(n) {
    if (!isFinite(n) || n <= 0) return "$0";

    const s = n.toFixed(12); // plenty of precision
    const parts = s.split(".");
    const dec = (parts[1] || "").replace(/0+$/, ""); // trim trailing zeros

    if (!dec) return "$0";

    let zeroCount = 0;
    let digits = "";
    for (const ch of dec) {
      if (ch === "0" && digits === "") {
        zeroCount++;
      } else {
        digits += ch;
      }
    }
    if (!digits) return "$0";

    const sub = toSubscript(zeroCount);
    return `$0.0${sub}${digits}`;
  }

  function formatUsd(value) {
    if (value === null || value === undefined || isNaN(value)) return "N/A";
    const n = Number(value);
    if (!isFinite(n) || n <= 0) return "$0";

    // Tiny memecoin style
    if (n < 0.0001) {
      return formatTinyUsd(n);
    }

    // Normal ranges
    if (n < 1) {
      return (
        "$" +
        n
          .toFixed(6)
          .replace(/0+$/, "")
          .replace(/\.$/, "")
      );
    }
    if (n < 1000) {
      return (
        "$" +
        n
          .toFixed(4)
          .replace(/0+$/, "")
          .replace(/\.$/, "")
      );
    }
    if (n < 1_000_000) {
      return "$" + n.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    if (n < 1_000_000_000) {
      return (
        "$" +
        (n / 1_000_000)
          .toFixed(2)
          .replace(/0+$/, "")
          .replace(/\.$/, "") +
        "M"
      );
    }
    if (n < 1_000_000_000_000) {
      return (
        "$" +
        (n / 1_000_000_000)
          .toFixed(2)
          .replace(/0+$/, "")
          .replace(/\.$/, "") +
        "B"
      );
    }
    return (
      "$" +
      (n / 1_000_000_000_000)
        .toFixed(2)
        .replace(/0+$/, "")
        .replace(/\.$/, "") +
      "T"
    );
  }

  // ---------- OTHER HELPERS ----------

  function formatNumber(value) {
    if (value == null || isNaN(value)) return "‚Äî";
    const n = Number(value);
    if (n < 1_000_000) {
      return n.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    if (n < 1_000_000_000) {
      return (n / 1_000_000).toFixed(2) + "M";
    }
    if (n < 1_000_000_000_000) {
      return (n / 1_000_000_000).toFixed(2) + "B";
    }
    return (n / 1_000_000_000_000).toFixed(2) + "T";
  }

  function shortAddr(addr) {
    if (!addr || addr.length <= 8) return addr;
    return addr.slice(0, 4) + "‚Ä¶" + addr.slice(-4);
  }

  function renderError(message) {
    errorBox.style.display = "block";
    errorBox.textContent =
      message || "Something went wrong while checking this mint.";
    resultBox.innerHTML = "";
  }

  function loadRecent() {
    try {
      const raw = localStorage.getItem(RECENT_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr;
    } catch {
      return [];
    }
  }

  function saveRecent(list) {
    try {
      localStorage.setItem(RECENT_KEY, JSON.stringify(list));
    } catch {
      // ignore
    }
  }

  function labelForRisk(level) {
    if (level === "low") return "Safe";
    if (level === "medium") return "Caution";
    if (level === "risky") return "Risky";
    if (level === "high") return "Very risky";
    return "Unknown";
  }

  function presetRiskClass(level) {
    if (level === "low") return "preset-risk-safe";
    if (level === "medium") return "preset-risk-caution";
    if (level === "risky") return "preset-risk-risky";
    if (level === "high") return "preset-risk-veryrisk";
    return "preset-risk-unknown";
  }

  function renderRecentRow() {
    const recent = loadRecent();
    if (!recent.length) {
      const defaults = [
        {
          mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1",
          display: "USDC",
          level: "low",
        },
        {
          mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
          display: "BONK",
          level: "medium",
        },
      ];
      recentRow.innerHTML = defaults
        .map(
          (r) => `
            <button class="preset-btn" data-mint="${r.mint}">
              ${r.display}
              <span class="${presetRiskClass(r.level)}">¬∑ ${labelForRisk(
            r.level
          )}</span>
            </button>`
        )
        .join("");
    } else {
      recentRow.innerHTML = recent
        .map(
          (r) => `
            <button class="preset-btn" data-mint="${r.mint}">
              ${r.display}
              <span class="${presetRiskClass(r.level)}">¬∑ ${labelForRisk(
            r.level
          )}</span>
            </button>`
        )
        .join("");
    }

    document.querySelectorAll(".preset-btn").forEach((btn) => {
      btn.onclick = () => {
        const mint = btn.getAttribute("data-mint");
        if (mint) {
          mintInput.value = mint;
          handleCheck();
        }
      };
    });
  }

  function addRecent(entry) {
    const current = loadRecent();
    const filtered = current.filter((r) => r.mint !== entry.mint);
    filtered.unshift(entry);
    const trimmed = filtered.slice(0, 5);
    saveRecent(trimmed);
    renderRecentRow();
  }

  function formatAge(tokenAge) {
    const days = tokenAge?.ageDays;
    if (days == null || isNaN(days)) {
      return { main: "‚Äî", sub: "" };
    }
    if (days < 1) {
      const hours = Math.floor(days * 24);
      return { main: `${hours}h`, sub: "since mint" };
    }
    if (days < 30) {
      const d = Math.floor(days);
      return { main: `${d}d`, sub: "since mint" };
    }
    if (days < 365) {
      const months = (days / 30).toFixed(1);
      return { main: `${months}m`, sub: `‚âà ${Math.floor(days)} days` };
    }
    const years = (days / 365).toFixed(1);
    return { main: `${years}y`, sub: `‚âà ${Math.floor(days)} days` };
  }

  // ---------- MAIN SCAN HANDLER ----------

  async function handleCheck() {
    const mint = (mintInput.value || "").trim();
    if (!mint) {
      renderError("Please paste a valid Solana token mint address.");
      return;
    }

    errorBox.style.display = "none";
    errorBox.textContent = "";
    setLoading(true);

    try {
      const res = await fetch(API_BASE + "?mint=" + encodeURIComponent(mint));
      const data = await res.json();

      if (!res.ok) {
        throw new Error(data?.error || "Backend error");
      }

      const {
        tokenMeta,
        mintInfo,
        freezeAuthority,
        mintAuthority,
        holderSummary,
        originHint,
        riskSummary,
        tokenMetrics,
        tokenAge,
      } = data;

      const canonicalMint = mint.trim();

      const jupUrl = `https://jup.ag/swap/SOL-${canonicalMint}?ref=3Gkf49tYL3JNjawedx9HX94LbnSMQ6eTQLTR8i8rkxWG`;
      const dexscreenerUrl = `https://dexscreener.com/solana/${canonicalMint}`;

      const riskLevel = riskSummary?.level || "unknown";
      let riskClass = "risk-med";
      let riskLabel = "Unknown risk";
      if (riskLevel === "low") {
        riskClass = "risk-low";
        riskLabel = "Low rug risk (mint side)";
      } else if (riskLevel === "medium") {
        riskClass = "risk-med";
        riskLabel = "Medium risk";
      } else if (riskLevel === "high") {
        riskClass = "risk-high";
        riskLabel = "High rug risk";
      }

      let scamScore = Number(riskSummary?.score);
      if (isNaN(scamScore) || scamScore < 0 || scamScore > 100) {
        if (riskLevel === "low") scamScore = 85;
        else if (riskLevel === "medium") scamScore = 55;
        else if (riskLevel === "high") scamScore = 20;
        else scamScore = 50;
      }

      const name = tokenMeta?.name || "Unknown Token";
      const symbol = tokenMeta?.symbol || "";
      const logo = tokenMeta?.logoURI || null;

      const priceUsd = tokenMetrics?.priceUsd ?? null;
      const liquidityUsd = tokenMetrics?.liquidityUsd ?? null;
      const globalFeesUsd = tokenMetrics?.globalFeesUsd ?? null;

      const rawSupply = mintInfo?.supply;
      const decimals = mintInfo?.decimals ?? 0;
      const supplyHuman =
        rawSupply != null
          ? Number(rawSupply) / Math.pow(10, decimals || 0)
          : null;

      const holdersTop10 = holderSummary?.top10Pct ?? null;
      const holdersBarWidth =
        holdersTop10 != null
          ? Math.min(100, Math.max(0, holdersTop10))
          : 0;
      const topHolders = holderSummary?.topHolders || [];

      const holdersLabel =
        holdersTop10 != null
          ? `${holdersTop10.toFixed(1)}% held by top 10 wallets`
          : "No holder data";

      const renouncedMint = !mintAuthority;
      const canMintMore = !!mintAuthority;
      const canFreeze = !!freezeAuthority;

      const originText = originHint?.label || "Unknown protocol / origin";
      const originDetail = originHint?.detail || "";

      const riskBlurb = riskSummary?.blurb || "";
      const scamScoreClamped = Math.min(100, Math.max(0, scamScore));
      const scamScoreScale = scamScoreClamped / 100;

      const holdersListHtml = topHolders.length
        ? `<div class="holders-list">
            ${topHolders
              .map((h, idx) => {
                const rank = String(idx + 1).padStart(2, "0");
                return `<a class="holder-chip" href="https://solscan.io/account/${h.address}" target="_blank" rel="noopener noreferrer">
                    ${rank}. ${shortAddr(h.address)} ¬∑ ${h.pct.toFixed(2)}%
                  </a>`;
              })
              .join("")}
          </div>`
        : `<div class="result-small" style="margin-top:4px;">
            Holder list not available for this mint yet.
          </div>`;

      const ageFmt = formatAge(tokenAge);

      // Update recents
      const displayForRecent =
        symbol || name || shortAddr(canonicalMint) || "Token";
      addRecent({
        mint: canonicalMint,
        display: displayForRecent,
        level: riskLevel,
      });

      resultBox.innerHTML = `
        <div class="result-header-line">
          <div class="risk-tag ${riskClass}">
            <span>‚óè</span>
            <span>${riskLabel}</span>
          </div>
          <div style="font-size:11px;color:var(--text-muted);">
            Live on-chain scan
          </div>
        </div>

        <div class="token-title-row">
          <div class="token-logo" style="${
            logo
              ? `background-image:url('${logo.replace(/'/g, "\\'")}');`
              : "background: radial-gradient(circle at 30% 10%, #4ade80, #16a34a);"
          }"></div>
          <div style="min-width:0;">
            <div class="token-title-main">
              <span>${name}</span>
              ${symbol ? `<span class="token-symbol">(${symbol})</span>` : ""}
            </div>
            <div class="token-mint">${canonicalMint}</div>
          </div>
        </div>

        ${
          riskBlurb
            ? `<div class="result-summary">
                <span class="summary-strong">${riskBlurb}</span>
              </div>`
            : ""
        }

        <div class="scam-score-wrap">
          <div class="scam-score-header">
            <span>GlassBox scam score (0‚Äì100)</span>
            <span class="scam-score-value">${scamScoreClamped.toFixed(
              0
            )}/100</span>
          </div>
          <div class="scam-score-bar">
            <div class="scam-score-fill" style="transform:scaleX(${scamScoreScale});"></div>
          </div>
        </div>

        <div class="metric-strip">
          <div class="metric-pill">
            <div class="metric-label">Price</div>
            <div class="metric-value">${formatUsd(priceUsd)}</div>
          </div>
          <div class="metric-pill">
            <div class="metric-label">Liquidity</div>
            <div class="metric-value">${formatUsd(liquidityUsd)}</div>
          </div>
          <div class="metric-pill">
            <div class="metric-label">Total Supply</div>
            <div class="metric-value">${
              supplyHuman != null ? formatNumber(supplyHuman) : "‚Äî"
            }</div>
          </div>
          <div class="metric-pill">
            <div class="metric-label">Global Fees Paid</div>
            <div class="metric-value">${formatUsd(globalFeesUsd)}</div>
          </div>
          <div class="metric-pill">
            <div class="metric-label">Token Age</div>
            <div class="metric-value">${ageFmt.main}</div>
            ${
              ageFmt.sub
                ? `<div class="metric-sub">${ageFmt.sub}</div>`
                : ""
            }
          </div>
        </div>

        <div class="result-sections">
          <div class="result-section">
            <h3>Mint &amp; freeze controls</h3>
            <div class="result-row">
              <span class="result-label">Mint authority</span>
              <span class="badge ${
                renouncedMint ? "badge-good" : "badge-bad"
              }">
                ${renouncedMint ? "Renounced / Disabled" : "Can still mint"}
              </span>
            </div>
            <div class="result-row">
              <span class="result-label">Freeze authority</span>
              <span class="badge ${canFreeze ? "badge-bad" : "badge-good"}">
                ${canFreeze ? "Can freeze tokens" : "None"}
              </span>
            </div>
            <div class="result-small">
              ${
                canMintMore
                  ? "Dev can still print new tokens into their own wallets or LP."
                  : "No more supply can be minted from this mint authority."
              }
            </div>
          </div>

          <div class="result-section">
            <h3>Holder risk</h3>
            <div class="result-row">
              <span class="result-label">Top 10 wallets</span>
              <span class="badge ${
                holdersTop10 != null && holdersTop10 <= 25
                  ? "badge-good"
                  : holdersTop10 != null && holdersTop10 <= 60
                  ? "badge-warn"
                  : "badge-bad"
              }">
                ${
                  holdersTop10 != null
                    ? `${holdersTop10.toFixed(1)}%`
                    : "Unknown"
                }
              </span>
            </div>
            <div class="holders-bar">
              <div class="holders-bar-fill" style="width:${holdersBarWidth}%;"></div>
            </div>
            <div class="result-small">${holdersLabel}</div>
            ${holdersListHtml}
          </div>
        </div>

        <div class="result-section">
          <h3>Origin signal</h3>
          <div class="origin-row">
            <strong>${originText}</strong>${
        originDetail ? ` ¬∑ ${originDetail}` : ""
      }
          </div>
          <div class="result-small">
            Origin hints help you see whether this came from a known protocol (Pump, Bags,
            Raydium, Moonshot, etc.) or a custom deployment.
          </div>
        </div>

        <div class="result-section">
          <h3>Tools</h3>
          <div class="tools-row">
            <a class="tool-btn" href="${dexscreenerUrl}" target="_blank" rel="noopener noreferrer">
              <span>üìä DexScreener</span>
            </a>
            <a class="tool-btn" href="https://axiom.trade/@dudexyz" target="_blank" rel="noopener noreferrer">
              <span>üìà Axiom</span>
            </a>
            <a class="tool-btn" href="https://t.me/BullxBetaBot?start=access_N3OJF4TE16J" target="_blank" rel="noopener noreferrer">
              <span>üêÇ BullX Bot</span>
            </a>
            <a class="tool-btn" href="https://trade.padre.gg/rk/dudexyz" target="_blank" rel="noopener noreferrer">
              <span>üß† Padre</span>
            </a>
            <a class="tool-btn" href="https://photon-sol.tinyastro.io/@xyzthegod" target="_blank" rel="noopener noreferrer">
              <span>‚ö° Photon</span>
            </a>
            <a class="tool-btn" href="https://stalk.fun/?r=ZATEZOJI" target="_blank" rel="noopener noreferrer">
              <span>üëÅÔ∏è StalkFun</span>
            </a>
          </div>
          <div class="result-small">
            These are your referral links. Using them supports GlassBox at no extra cost to the user.
          </div>
          <div class="result-small" style="margin-top:4px;text-align:right;font-size:10px;">
            <span style="opacity:0.85;">GlassBox Pro (degen alerts &amp; MEV shield) coming soon.</span>
          </div>
        </div>

        <div class="actions-row">
          <div class="actions-left">
            <a
              class="btn-secondary"
              href="${jupUrl}"
              target="_blank"
              rel="noopener noreferrer"
            >
              üîÑ Swap on Jupiter
            </a>
          </div>
          <div class="actions-right">
            <button class="btn-ghost" id="copyMintBtn">
              üìã Copy mint
            </button>
          </div>
        </div>
      `;

      const copyBtn = document.getElementById("copyMintBtn");
      if (copyBtn) {
        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(canonicalMint);
            copyBtn.textContent = "‚úÖ Copied";
            setTimeout(() => {
              copyBtn.textContent = "üìã Copy mint";
            }, 1200);
          } catch (e) {
            console.error(e);
          }
        };
      }
    } catch (err) {
      console.error(err);
      renderError(err.message || "Failed to scan this mint.");
    } finally {
      setLoading(false);
    }
  }

  checkBtn.addEventListener("click", handleCheck);
  mintInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      handleCheck();
    }
  });

  // initial recent row
  renderRecentRow();
</script>

</head>
<body>
  <div class="app">
    <div class="shell">
      <div class="inner">
        <!-- LEFT / INPUT -->
        <div>
          <div class="hero-pill">
            <span>üü¢ GlassBox v0.1</span>
            <span>Mint ¬∑ Freeze ¬∑ Holders ¬∑ Origin</span>
          </div>
          <div class="hero-title">
            Paste a Solana token mint.<br />
            See if it‚Äôs <span style="color: var(--accent)">clean or toxic</span> in seconds.
          </div>
          <div class="hero-sub">
            No wallet connect. No signup. Just an instant on-chain safety read on any SPL token mint.
          </div>

          <div class="input-block">
            <div class="input-label-row">
              <div class="input-label">Token mint address</div>
              <div class="input-hint">Solana SPL or Token-2022 mint</div>
            </div>
            <div class="input-row">
              <input
                id="mintInput"
                type="text"
                placeholder="Ex: EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1 (USDC)"
              />
              <button id="checkBtn" class="btn-primary">
                <span id="checkBtnLabel">Scan</span>
                <span id="checkBtnSpinner" style="display:none;">‚è≥</span>
              </button>
            </div>
            <div class="hint-row">
              <div class="hint-pill">
                <span>üí°</span>
                <span>We never see or store your wallet or keys.</span>
              </div>
              <div class="preset-row" id="recentRow">
                <!-- recent tokens rendered by JS -->
              </div>
            </div>
          </div>

          <footer>
            Built for degen safety by <a href="https://x.com/" target="_blank" rel="noopener noreferrer">@yourhandle</a>
          </footer>
        </div>

        <!-- RIGHT / RESULT -->
        <div>
          <div class="result-card" id="resultCard">
            <div id="resultBox" style="font-size:12px;color:var(--text-muted);">
              Paste a Solana token mint on the left and hit <strong>Scan</strong> to see:
              <ul style="padding-left:18px;margin:6px 0 2px;">
                <li>Mint &amp; freeze authority status</li>
                <li>Holder concentration risk + top wallets</li>
                <li>Protocol origin hints</li>
                <li>Readable supply, price, liquidity &amp; token age</li>
              </ul>
              Then route to Jupiter, DexScreener, Axiom, Photon, BullX, Padre, or StalkFun in one tap.
            </div>
            <div id="errorBox" class="error-box" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/api/check";
    const RECENT_KEY = "glassbox_recent_mints_v1";

    const mintInput = document.getElementById("mintInput");
    const checkBtn = document.getElementById("checkBtn");
    const checkBtnLabel = document.getElementById("checkBtnLabel");
    const checkBtnSpinner = document.getElementById("checkBtnSpinner");
    const resultBox = document.getElementById("resultBox");
    const errorBox = document.getElementById("errorBox");
    const recentRow = document.getElementById("recentRow");

    function setLoading(isLoading) {
      if (isLoading) {
        checkBtn.disabled = true;
        checkBtnLabel.textContent = "Scanning‚Ä¶";
        checkBtnSpinner.style.display = "inline";
      } else {
        checkBtn.disabled = false;
        checkBtnLabel.textContent = "Scan";
        checkBtnSpinner.style.display = "none";
      }
    }

    function formatUsd(value) {
  if (value === null || value === undefined) return "N/A";
  const n = Number(value);
  if (!isFinite(n)) return "N/A";
  if (n === 0) return "$0";

  if (n < 1) {
    return "$" + n.toFixed(6);          // fine for liquidity/fees
  }
  if (n < 1000) {
    return "$" + n.toFixed(2);
  }
  if (n < 1_000_000) {
    return "$" + n.toLocaleString(undefined, { maximumFractionDigits: 0 });
  }
  if (n < 1_000_000_000) {
    return "$" + (n / 1_000_000).toFixed(2) + "M";
  }
  if (n < 1_000_000_000_000) {
    return "$" + (n / 1_000_000_000).toFixed(2) + "B";
  }
  return "$" + (n / 1_000_000_000_000).toFixed(2) + "T";
}

    function formatNumber(value) {
      if (value == null || isNaN(value)) return "‚Äî";
      const n = Number(value);
      if (n < 1_000_000) {
        return n.toLocaleString(undefined, { maximumFractionDigits: 0 });
      }
      if (n < 1_000_000_000) {
        return (n / 1_000_000).toFixed(2) + "M";
      }
      if (n < 1_000_000_000_000) {
        return (n / 1_000_000_000).toFixed(2) + "B";
      }
      return (n / 1_000_000_000_000).toFixed(2) + "T";
    }

    function formatPrice(value) {
  if (value === null || value === undefined) return "N/A";
  const n = Number(value);
  if (!isFinite(n) || n <= 0) return "N/A";

  // Normal prices
  if (n >= 1) {
    return "$" + n.toFixed(4).replace(/\.?0+$/, "");
  }

  // n < 1 ‚Üí Dexscreener style like $0.0‚ÇÜ57
  const s = n.toFixed(12);          // "0.00000057"
  const match = s.match(/^0\.0*(\d.*)$/);
  if (!match) {
    return "$" + n.toFixed(8).replace(/\.?0+$/, "");
  }

  const decimalsPart = s.slice(2);  // e.g. "00000057"
  const firstNonZeroIndex = decimalsPart.search(/[1-9]/);
  if (firstNonZeroIndex <= 0) {
    return "$" + n.toFixed(8).replace(/\.?0+$/, "");
  }

  const zeroCount = firstNonZeroIndex;               // 6 zeros ‚Üí "‚ÇÜ"
  const significant = decimalsPart.slice(firstNonZeroIndex); // "57"

  return `$0.0<span class="price-subscript">${zeroCount}</span>${significant}`;
}

    function shortAddr(addr) {
      if (!addr || addr.length <= 8) return addr;
      return addr.slice(0, 4) + "‚Ä¶" + addr.slice(-4);
    }

    function renderError(message) {
      errorBox.style.display = "block";
      errorBox.textContent = message || "Something went wrong while checking this mint.";
      resultBox.innerHTML = "";
    }

    function loadRecent() {
      try {
        const raw = localStorage.getItem(RECENT_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
      } catch {
        return [];
      }
    }

    function saveRecent(list) {
      try {
        localStorage.setItem(RECENT_KEY, JSON.stringify(list));
      } catch {
        // ignore
      }
    }

    function labelForRisk(level) {
      if (level === "low") return "Safe";
      if (level === "medium") return "Caution";
      if (level === "risky") return "Risky";
      if (level === "high") return "Very risky";
      return "Unknown";
    }

    function presetRiskClass(level) {
      if (level === "low") return "preset-risk-safe";
      if (level === "medium") return "preset-risk-caution";
      if (level === "risky") return "preset-risk-risky";
      if (level === "high") return "preset-risk-veryrisk";
      return "preset-risk-unknown";
    }

    function renderRecentRow() {
      const recent = loadRecent();
      if (!recent.length) {
        const defaults = [
          {
            mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1",
            display: "USDC",
            level: "low",
          },
          {
            mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
            display: "BONK",
            level: "medium",
          },
        ];
        recentRow.innerHTML = defaults
          .map(
            (r) =>
              `<button class="preset-btn" data-mint="${r.mint}">
                 ${r.display}
                 <span class="${presetRiskClass(r.level)}">¬∑ ${labelForRisk(r.level)}</span>
               </button>`
          )
          .join("");
      } else {
        recentRow.innerHTML = recent
          .map(
            (r) =>
              `<button class="preset-btn" data-mint="${r.mint}">
                 ${r.display}
                 <span class="${presetRiskClass(r.level)}">¬∑ ${labelForRisk(r.level)}</span>
               </button>`
          )
          .join("");
      }

      document.querySelectorAll(".preset-btn").forEach((btn) => {
        btn.onclick = () => {
          const mint = btn.getAttribute("data-mint");
          if (mint) {
            mintInput.value = mint;
            handleCheck();
          }
        };
      });
    }

    function addRecent(entry) {
      const current = loadRecent();
      const filtered = current.filter((r) => r.mint !== entry.mint);
      filtered.unshift(entry);
      const trimmed = filtered.slice(0, 5);
      saveRecent(trimmed);
      renderRecentRow();
    }

    function formatAge(tokenAge) {
      const days = tokenAge?.ageDays;
      if (days == null || isNaN(days)) {
        return { main: "‚Äî", sub: "" };
      }
      if (days < 1) {
        const hours = Math.floor(days * 24);
        return {
          main: `${hours}h`,
          sub: "since mint",
        };
      }
      if (days < 30) {
        const d = Math.floor(days);
        return {
          main: `${d}d`,
          sub: "since mint",
        };
      }
      if (days < 365) {
        const months = (days / 30).toFixed(1);
        return {
          main: `${months}m`,
          sub: `‚âà ${Math.floor(days)} days`,
        };
      }
      const years = (days / 365).toFixed(1);
      return {
        main: `${years}y`,
        sub: `‚âà ${Math.floor(days)} days`,
      };
    }

    async function handleCheck() {
      const mint = (mintInput.value || "").trim();
      if (!mint) {
        renderError("Please paste a valid Solana token mint address.");
        return;
      }

      errorBox.style.display = "none";
      errorBox.textContent = "";
      setLoading(true);

      try {
        const res = await fetch(API_BASE + "?mint=" + encodeURIComponent(mint));
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data?.error || "Backend error");
        }

        const {
          tokenMeta,
          mintInfo,
          freezeAuthority,
          mintAuthority,
          holderSummary,
          originHint,
          riskSummary,
          tokenMetrics,
          tokenAge,
          lockInfo,
          dexInfo,
        } = data;

        const canonicalMint = mint.trim();

        const jupUrl = `https://jup.ag/swap/SOL-${canonicalMint}?ref=3Gkf49tYL3JNjawedx9HX94LbnSMQ6eTQLTR8i8rkxWG`;
        const dexscreenerUrl = `https://dexscreener.com/solana/${canonicalMint}`;

        const riskLevel = riskSummary?.level || "unknown";
        let riskClass = "risk-med";
        let riskLabel = "Unknown risk";
        if (riskLevel === "low") {
          riskClass = "risk-low";
          riskLabel = "Low rug risk (mint side)";
        } else if (riskLevel === "medium") {
          riskClass = "risk-med";
          riskLabel = "Medium risk";
        } else if (riskLevel === "high") {
          riskClass = "risk-high";
          riskLabel = "High rug risk";
        }

        let scamScore = Number(riskSummary?.score);
        if (isNaN(scamScore) || scamScore < 0 || scamScore > 100) {
          if (riskLevel === "low") scamScore = 85;
          else if (riskLevel === "medium") scamScore = 55;
          else if (riskLevel === "high") scamScore = 20;
          else scamScore = 50;
        }

        const name = tokenMeta?.name || "Unknown Token";
        const symbol = tokenMeta?.symbol || "";
        const logo = tokenMeta?.logoURI || null;

        // metrics
        const priceUsd = tokenMetrics?.priceUsd ?? null;
        const liquidityUsd = tokenMetrics?.liquidityUsd ?? null;
        const globalFeesUsd = tokenMetrics?.globalFeesUsd ?? null;

        const rawSupply = mintInfo?.supply;
        const decimals = mintInfo?.decimals ?? 0;
        const supplyHuman =
          rawSupply != null
            ? Number(rawSupply) / Math.pow(10, decimals || 0)
            : null;

        // locked / burned info (comes from backend later; placeholders for now)
        const lockedPct = lockInfo?.lockedPct ?? null;
        const burnedPct = lockInfo?.burnedPct ?? null;
        const hasLockData = lockedPct != null || burnedPct != null;
        const totalLockedBurned =
          (lockedPct != null ? lockedPct : 0) +
          (burnedPct != null ? burnedPct : 0);

        let lockedLabel;
        let lockedBadgeClass = "badge-warn";

        if (!hasLockData) {
          lockedLabel = "N/A (indexer soon)";
        } else {
          lockedLabel = `${totalLockedBurned.toFixed(1)}% locked / burned`;
          lockedBadgeClass =
            totalLockedBurned >= 80 ? "badge-good" : "badge-warn";
        }

        // dex paid / boost info (from Dexscreener/API later)
        const dexPaid = dexInfo?.dexPaid ?? null;
        const dexBoost = dexInfo?.boostLabel ?? null;

        let dexLabel = "N/A (Dexscreener soon)";
        let dexBadgeClass = "badge-warn";

        if (dexPaid === true && dexBoost) {
          dexLabel = `Paid ¬∑ Boost ${dexBoost}`;
          dexBadgeClass = "badge-good";
        } else if (dexPaid === true) {
          dexLabel = "Paid listing";
          dexBadgeClass = "badge-good";
        } else if (dexPaid === false) {
          dexLabel = "No paid listing detected";
          dexBadgeClass = "badge-bad";
        }

        const holdersTop10 = holderSummary?.top10Pct ?? null;
        const holdersBarWidth =
          holdersTop10 != null
            ? Math.min(100, Math.max(0, holdersTop10))
            : 0;
        const topHolders = holderSummary?.topHolders || [];

        const holdersLabel =
          holdersTop10 != null
            ? `${holdersTop10.toFixed(1)}% held by top 10 wallets`
            : "No holder data";

        const renouncedMint = !mintAuthority;
        const canMintMore = !!mintAuthority;
        const canFreeze = !!freezeAuthority;

        const originText = originHint?.label || "Unknown protocol / origin";
        const originDetail = originHint?.detail || "";

        const riskBlurb = riskSummary?.blurb || "";
        const scamScoreClamped = Math.min(100, Math.max(0, scamScore));
        const scamScoreScale = scamScoreClamped / 100;

        const holdersListHtml = topHolders.length
          ? `<div class="holders-list">
              ${topHolders
                .map((h, idx) => {
                  const rank = String(idx + 1).padStart(2, "0");
                  return `<a class="holder-chip" href="https://solscan.io/account/${h.address}" target="_blank" rel="noopener noreferrer">
                      ${rank}. ${shortAddr(h.address)} ¬∑ ${h.pct.toFixed(2)}%
                    </a>`;
                })
                .join("")}
             </div>`
          : `<div class="result-small" style="margin-top:4px;">
               Holder list not available for this mint yet.
             </div>`;

        const ageFmt = formatAge(tokenAge);

        // Update recent tokens list
        const displayForRecent =
          symbol || name || shortAddr(canonicalMint) || "Token";
        addRecent({
          mint: canonicalMint,
          display: displayForRecent,
          level: riskLevel,
        });

        resultBox.innerHTML = `
          <div class="result-header-line">
            <div class="risk-tag ${riskClass}">
              <span>‚óè</span>
              <span>${riskLabel}</span>
            </div>
            <div style="font-size:11px;color:var(--text-muted);">
              Live on-chain scan
            </div>
          </div>

          <div class="token-title-row">
            <div class="token-logo" style="${
              logo
                ? `background-image:url('${logo.replace(/'/g, "\\'")}');`
                : "background: radial-gradient(circle at 30% 10%, #4ade80, #16a34a);"
            }"></div>
            <div style="min-width:0;">
              <div class="token-title-main">
                <span>${name}</span>
                ${symbol ? `<span class="token-symbol">(${symbol})</span>` : ""}
              </div>
              <div class="token-mint">${canonicalMint}</div>
            </div>
          </div>

          ${
            riskBlurb
              ? `<div class="result-summary">
                  <span class="summary-strong">${riskBlurb}</span>
                </div>`
              : ""
          }

          <div class="scam-score-wrap">
            <div class="scam-score-header">
              <span>GlassBox scam score (0‚Äì100)</span>
              <span class="scam-score-value">${scamScoreClamped.toFixed(
                0
              )}/100</span>
            </div>
            <div class="scam-score-bar">
              <div class="scam-score-fill" style="transform:scaleX(${scamScoreScale});"></div>
            </div>
          </div>

          <div class="metric-strip">
            <div class="metric-pill">
              <div class="metric-label">Price</div>
              <div class="metric-value">${formatUsd(priceUsd)}</div>
            </div>
            <div class="metric-pill">
              <div class="metric-label">Liquidity</div>
              <div class="metric-value">${formatPrice(priceUsd)}</div>
            </div>
            <div class="metric-pill">
              <div class="metric-label">Total Supply</div>
              <div class="metric-value">
                ${
                  supplyHuman != null
                    ? formatNumber(supplyHuman)
                    : "‚Äî"
                }
              </div>
            </div>
            <div class="metric-pill">
              <div class="metric-label">Global Fees Paid</div>
              <div class="metric-value">${formatUsd(globalFeesUsd)}</div>
            </div>
            <div class="metric-pill">
              <div class="metric-label">Token Age</div>
              <div class="metric-value">${ageFmt.main}</div>
              ${
                ageFmt.sub
                  ? `<div class="metric-sub">${ageFmt.sub}</div>`
                  : ""
              }
            </div>
          </div>

          <div class="result-sections">
            <div class="result-section">
              <h3>Mint &amp; freeze controls</h3>
              <div class="result-row">
                <span class="result-label">Mint authority</span>
                <span class="badge ${
                  renouncedMint ? "badge-good" : "badge-bad"
                }">${renouncedMint ? "Renounced / Disabled" : "Can still mint"}</span>
              </div>
              <div class="result-row">
                <span class="result-label">Freeze authority</span>
                <span class="badge ${
                  canFreeze ? "badge-bad" : "badge-good"
                }">${canFreeze ? "Can freeze tokens" : "None"}</span>
              </div>
              <div class="result-row">
                <span class="result-label">Locked / burned</span>
                <span class="badge ${lockedBadgeClass}">${lockedLabel}</span>
              </div>
              <div class="result-row">
                <span class="result-label">DEX paid / boost</span>
                <span class="badge ${dexBadgeClass}">${dexLabel}</span>
              </div>
              <div class="result-small">
                ${
                  canMintMore
                    ? "Dev can still print new tokens into their own wallets or LP."
                    : "No more supply can be minted from this mint authority."
                }
              </div>
            </div>

            <div class="result-section">
              <h3>Holder risk</h3>
              <div class="result-row">
                <span class="result-label">Top 10 wallets</span>
                <span class="badge ${
                  holdersTop10 != null && holdersTop10 <= 25
                    ? "badge-good"
                    : holdersTop10 != null && holdersTop10 <= 60
                    ? "badge-warn"
                    : "badge-bad"
                }">
                  ${holdersTop10 != null ? `${holdersTop10.toFixed(1)}%` : "Unknown"}
                </span>
              </div>
              <div class="holders-bar">
                <div class="holders-bar-fill" style="width:${holdersBarWidth}%;"></div>
              </div>
              <div class="result-small">${holdersLabel}</div>
              ${holdersListHtml}
            </div>
          </div>

          <div class="result-section">
            <h3>Origin signal</h3>
            <div class="origin-row">
              <strong>${originText}</strong>${
                originDetail ? ` ¬∑ ${originDetail}` : ""
              }
            </div>
            <div class="result-small">
              Origin hints help you see whether this came from a known protocol (Pump, Bags, Raydium, Moonshot, etc.) or a custom deployment.
            </div>
          </div>

          <div class="result-section">
            <h3>Tools</h3>
            <div class="tools-row">
              <a class="tool-btn" href="${dexscreenerUrl}" target="_blank" rel="noopener noreferrer">
                <span>üìä DexScreener</span>
              </a>
              <a class="tool-btn" href="https://axiom.trade/@dudexyz" target="_blank" rel="noopener noreferrer">
                <span>üìà Axiom</span>
              </a>
              <a class="tool-btn" href="https://t.me/BullxBetaBot?start=access_N3OJF4TE16J" target="_blank" rel="noopener noreferrer">
                <span>üêÇ BullX Bot</span>
              </a>
              <a class="tool-btn" href="https://trade.padre.gg/rk/dudexyz" target="_blank" rel="noopener noreferrer">
                <span>üß† Padre</span>
              </a>
              <a class="tool-btn" href="https://photon-sol.tinyastro.io/@xyzthegod" target="_blank" rel="noopener noreferrer">
                <span>‚ö° Photon</span>
              </a>
              <a class="tool-btn" href="https://stalk.fun/?r=ZATEZOJI" target="_blank" rel="noopener noreferrer">
                <span>üëÅÔ∏è StalkFun</span>
              </a>
            </div>
            <div class="result-small">
              These are your referral links. Using them supports GlassBox at no extra cost to the user.
            </div>
            <div class="result-small" style="margin-top:4px;text-align:right;font-size:10px;">
              <span style="opacity:0.85;">GlassBox Pro (degen alerts &amp; MEV shield) coming soon.</span>
            </div>
          </div>

          <div class="actions-row">
            <div class="actions-left">
              <a
                class="btn-secondary"
                href="${jupUrl}"
                target="_blank"
                rel="noopener noreferrer"
              >
                üîÑ Swap on Jupiter
              </a>
            </div>
            <div class="actions-right">
              <button class="btn-ghost" id="copyMintBtn">
                üìã Copy mint
              </button>
            </div>
          </div>
        `;

        const copyBtn = document.getElementById("copyMintBtn");
        if (copyBtn) {
          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(canonicalMint);
              copyBtn.textContent = "‚úÖ Copied";
              setTimeout(() => {
                copyBtn.textContent = "üìã Copy mint";
              }, 1200);
            } catch (e) {
              console.error(e);
            }
          };
        }
      } catch (err) {
        console.error(err);
        renderError(err.message || "Failed to scan this mint.");
      } finally {
        setLoading(false);
      }
    }

    checkBtn.addEventListener("click", handleCheck);
    mintInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleCheck();
      }
    });

    // initial recent row
    renderRecentRow();
  </script>
</body>
</html>
